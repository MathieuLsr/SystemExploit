// Include pour ma lib perso
#include "../../headers/gestionFichiers.h"

// Include pour printf
#include <stdio.h>

#include <string.h>

// Include pour les process
#include <unistd.h> // pipe
#include <sys/types.h>

#include <fcntl.h>

// Include pour Wait
#include <sys/wait.h>

// Pour Exit
#include <stdlib.h>

// Pour errno
#include <errno.h>

#define READ 0 
#define WRITE 1 

int main(int argc, char const *argv[])
{
    
    printf("Lancement test1b1...\n") ; 

    int fd[2] ;

    int i = pipe(fd) ;
    if(i == -1){
        perror("Erreur à la création du pipe.") ;
        exit(1) ; 
    }

    // Le fils attend une saisie au clavier et l'écrit dans le pipe Write
    if(fork() == 0){

        close(fd[READ]) ;

        char* text = getAllText(0) ;
        ecritLigne(fd[WRITE], text) ;
        close(fd[WRITE]) ;

    }

    // Le père attend que le fils termine d'écrire puis crée/ouvre
    // le file data.txt pour écrire ce qu'il a lu dans le pipe Read
    else {

        close(fd[WRITE]) ;
        wait(NULL) ;

        // Create .txt, écrire, close .txt & pipe
        char* path = "/Users/mathieulesur/Downloads/ESIEE/3ème Année/System Exploit/TDm3/src/test1b1_bis/data.txt" ;

        // Remove pour clear le file
        int r = remove(path) ;
        if(r == -1) printf("Aucun fichier data.txt existant.\n");

        int descTxt = open(path, O_WRONLY|O_CREAT, S_IRUSR) ;
        if(descTxt == -1){
            printf("Impossible de créer le fichier data.txt : %s\n", strerror(errno)) ;
            exit(1) ;
        }

        char* c = getAllText(fd[READ]) ; 
        ecritLigne(descTxt, c) ;
        printf("Exit : %s\n", c) ;

        close(fd[READ]) ;
        close(descTxt) ;

    }

    return 0;
}
