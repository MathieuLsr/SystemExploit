// Include pour ma lib perso
#include "../../headers/gestionFichiers.h"

// Include pour printf
#include <stdio.h>

#include <string.h>

// Include pour les process
#include <unistd.h> // pipe
#include <sys/types.h>

#include <fcntl.h>

// Include pour Wait
#include <sys/wait.h>

// Pour Exit
#include <stdlib.h>

// Pour errno
#include <errno.h>


#define READ 0 
#define WRITE 1 

int main(int argc, char const *argv[])
{
    
    printf("Lancement test1b1...\n") ; 

    int fd[2] ;

    int i = pipe(fd) ;
    if(i == -1){
        perror("Erreur à la création du pipe.") ;
        exit(1) ;
    }

    // Le fils remplie le pipe Read des informations lues dans le fichier inputStream.txt
    if(fork() == 0){

        close(fd[READ]) ;

        char* path = "/Users/mathieulesur/Downloads/ESIEE/3ème Année/System Exploit/TDm3/src/test1b1/inputStream.txt" ;
        int descTxt = open(path, O_RDONLY) ;

        if(descTxt == -1){
            descTxt = open(path, O_RDONLY|O_CREAT) ;
        }

        if(descTxt == -1){ 
            printf("Impossible de créer le fichier inputStream.txt\n") ;
            exit(1) ;
        }
        
        char* text = getAllText(descTxt);
        ecritLigne(fd[WRITE], text) ;

        free(text) ;
        close(fd[WRITE]) ;
        close(descTxt) ;

    }

    // Le père attend que le fils termine d'écrire puis crée/ouvre
    // le file outputStream.txt pour écrire ce qu'il a lu dans le pipe Read
    else {

        close(fd[WRITE]) ;
        wait(NULL) ;
        // Create .txt, écrire, close .txt & pipe
        char* path = "/Users/mathieulesur/Downloads/ESIEE/3ème Année/System Exploit/TDm3/src/test1b1/outputStream.txt" ;

        // Remove pour clear le file
        int r = remove(path) ;
        if(r == -1) printf("Aucun fichier outputStream.txt existant.\n");

        int descTxt = open(path, O_WRONLY|O_CREAT, S_IRUSR) ;
        if(descTxt == -1){
            printf("Impossible de créer le fichier outputStream.txt : %s\n", strerror(errno)) ;
            exit(1) ;
        }

        char* c = getAllText(fd[READ]) ;
        ecritLigne(descTxt, c) ;
        printf("Exit : %s\n", c) ;

        free(c) ;
        close(fd[READ]) ;
        close(descTxt) ;

    }

    return 0;
}
