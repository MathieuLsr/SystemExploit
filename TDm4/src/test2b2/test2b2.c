/*

        NON FONCTIONNEL
        NON FONCTIONNEL
        NON FONCTIONNEL

*/



// Include pour ma lib perso
#include "../../headers/gestionFichiers.h"

// Include pour printf
#include <stdio.h>

#include <string.h>

// Include pour les process
#include <unistd.h> // pipe
#include <sys/types.h>

#include <fcntl.h>

// Include pour Wait
#include <sys/wait.h>

// Pour Exit
#include <stdlib.h>

// Pour errno
#include <errno.h>

// Pour les Threads
#include <pthread.h>

// Pour les semaphores
#ifdef __APPLE__
#include <dispatch/dispatch.h>
#else
#include <semaphore.h>
#endif

#define N_LOOP 3 

//dispatch_semaphore_t sems[N_LOOP] ;
dispatch_semaphore_t sem_thread[3] ;  

void* Run(void* arg){
    
    //pthread_mutex_unlock(&mutex);
    printf("Lancement du Thread\n") ;

    int number = (int) arg ;
    int next = number == 2 ? 0 : number+1 ;

    for(int i=0 ; i<N_LOOP ; i++) {
        
        printf("-\n") ;
        printf("Thread n°%d, i = %d\n", number, i+1) ;

        printf("Libere le thread %d\n", next) ;
        dispatch_semaphore_signal(&sem_thread[next]);

        printf("Mise en attente du thread %d\n", number) ;
        dispatch_semaphore_wait(&sem_thread[number], DISPATCH_TIME_FOREVER) ;

        //sem_wait(&sems[i+1]) ;

    }
    printf("Fin du Thread n°%d\n", number) ;
    //pthread_mutex_unlock(&mutex);
    return NULL;
}

int main()
{
    
    printf("Lancement test2b2...\n") ; 

    /*
    int sem_init(sem_t *sem, int pshared, unsigned int value);
    int sem_destroy(sem_t *sem);
    int sem_wait(sem_t *sem);
    int sem_post(sem_t *sem);
    */


    // Sem' pour le controle des threads
    for(int i=0 ; i<N_LOOP ; i++){
        printf("Create Semaphore %d", i) ;
        sem_thread[i] = dispatch_semaphore_create(0) ;
        if(sem_thread[i] == NULL) printf("Error dispatch_semaphore_create") ;
    }

    /*
    dispatch_semaphore_t sems[N_LOOP] ;
    // Initialisation des 10 semaphores pour les boucles
    for(int i=0 ; i<N_LOOP ; i++){
        int err = sem_init(&sems[i], 0, 0) ;
        if(err!=0) printf("Erreur sur les semaphores loops 2 : %d\n", err) ;
    }
    */


    int nb_thread = 3 ; 
    pthread_t pthread[nb_thread] ; 
    int ithread[nb_thread] ;    

    

    for(int i=0 ; i<nb_thread ; i++){

        ithread[i] = pthread_create(&pthread[i], NULL, Run, (void*)i);

        if (ithread[i]){
            printf("ERROR : pthread_create() is %d\n", ithread[i]);
        }
        //pthread_join(pthread[i], NULL) ;

    }
    
    for(int i=0 ; i<nb_thread ; i++) pthread_join(pthread[i], NULL) ;


    //sem_destroy(sem) ;

    return 0;
}

